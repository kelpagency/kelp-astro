---
import { Picture } from 'astro:assets';
import 'flickity/css/flickity.css';
import 'flickity-fade/flickity-fade.css';

// Accept optional props
const { tag, category, limit = 6, heading = "Our Work", subheading = "In the real-world", description = "The proof is in the pudding as they say here in the south. Weird sayings aside, it’s one thing to have a good strategy, but it takes special talent to deliver on that strategy with excellence. Take a peak at some of our recent work below." } = Astro.props;

// helper to strip HTML tags from WP excerpts
const decodeEntities = (str = '') =>
	str.replace(/&#(\d+);/g, (_, dec) => String.fromCharCode(dec))
		.replace(/&nbsp;/g, ' ')
		.replace(/&amp;/g, '&')
		.replace(/&quot;/g, '"')
		.replace(/&apos;/g, "'");

const stripHTML = (html = '') =>
	decodeEntities(html.replace(/<[^>]*>/g, '').trim());
	
// Build query params dynamically
let queryParams = `per_page=${limit}`;

if (tag) {
	queryParams += `&tags=${tag}`; // use tag slug
}

if (category) {
	queryParams += `&categories=${category}`;
}

// Fetch posts with filters applied
const response = await fetch(
	`${import.meta.env.PUBLIC_WP_URL}/work?${queryParams}&_embed`
);
const posts = await response.json();

const postsWithImages = await Promise.all(
	posts.map(async (post) => {
		let heroImageUrl = null;

		// if ACF + hero.image exists + is numeric id
		if (post?.acf?.hero?.image) {
			try {
				const mediaRes = await fetch(
					`${import.meta.env.PUBLIC_WP_URL}/media/${post.acf.hero.image}`
				);
				const media = await mediaRes.json();
				heroImageUrl = media?.source_url ?? null;
			} catch (e) {
				heroImageUrl = null;
			}
		}

		return {
			...post,
			heroImageUrl
		};
	})
);
---

<section class='recent-work'>
	<div class='wrapper'>
		<div class='recent-work-top'>
			<h2 class='h3'>{heading} <span>{subheading}</span></h2>
			<p set:html={description}></p>
		</div>
		<div class='recent-work-slider'>
			{
				postsWithImages.map((post) => (
					<div class='recent-work-slider-item'>
						<div class='recent-work-slider-item-media'>
							<Picture
								src={post.heroImageUrl || post.fimg_url}
								alt={post.title.rendered}
								width={980}
								height={552}
								widths={[480, 720, 980]}
								sizes="(max-width: 900px) 100vw, 70vw"
								loading="lazy"
								class="recent-work-slider-item-media-img"
								inferSize
							/>
						</div>
						<div class='recent-work-slider-item-text'>
							<h3 class='recent-work-slider-item-text-heading h6' transition:name=`heading-${post.id}` set:html={post.title.rendered} />
							<div class='recent-work-slider-item-text-body'>
								<p class="recent-work-slider-item-text-body-p">
									{stripHTML(post.excerpt.rendered)}
								</p>
								<p class="recent-work-slider-item-text-body-p">
									<a href=`/work/${post.slug}/` class='squiggle'>
										Read More <span class="screen-reader-text">About {post.title.rendered}</span>
									</a>
								</p>
							</div>
						</div>
					</div>
				))
			}
			{posts.length > 1 && (
				<nav class="recent-work-slider-nav">
					<button class="button button--link button--prev">← Prev</button>
					<button class="button button--link button--next">Next →</button>
				</nav>
			)}
		</div>
	</div>
</section>

<style lang="scss">
	.recent-work {
		background: var(--black);
		padding: 9rem 0 3rem;
		color: white;
		position: relative;
		@media (max-width: 767px) {
			padding: 6rem 0 0rem;
		}
		&-top {
			max-width: 1180px;
			width: 100%;
			margin: auto;
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 4rem;
			@media (max-width: 850px) {
				display: block;
			}
			h2 {
				margin: 0;
				@media (min-width: 768px) {
					white-space: nowrap;
				}
				span {
					@media (min-width: 851px) {
						display: block;
						margin-left: 40px;
					}
				}
			}
		}
		&-slider {
			max-width: 980px;
			margin: 4rem auto;
			> .recent-work-slider-item {
				&:not(:first-child) {
					display: none;
				}
			}
			&-item {
				width: 100%;
				&-media {
					aspect-ratio: 1400 / 788;
					position: relative;
					img {
						width: 100%;
						height: 100%;
						object-fit: cover;
					}
				}
				&-text {
					display: flex;
					flex-wrap: wrap;
					align-items: flex-start;
					margin: 2rem 0;
					gap: 1rem 3rem;
					@media (min-width: 767px) {
						padding-right: 240px;
					}
					&-heading {
						margin: 0;
						flex: 1 1 100px;
					}
					&-body {
						flex: 1 1 400px;
						p {
							margin-top: 0;
						}
						&-p {
							margin-top: 0;
						}
						a {
							color: white;
							margin: 1rem 0;
						}
					}
				}
			}
			&-nav {
				flex: 0 0 auto;
				white-space: nowrap;
				display: flex;
				margin: 0 auto;
				position: absolute;
				top: 0;
				right: 0;
				z-index: 1;
				@media (min-width: 767px) {
					top: 70%;
				}
			}
		}
	}
</style>

<script>
	import Flickity from 'flickity';
	import 'flickity-fade';
	document.addEventListener('astro:page-load', () => {
		// recent work slider
		const slider = document.querySelector('.recent-work-slider');
		if (slider) {
			const next = document.querySelectorAll('.button--next');
			const prev = document.querySelectorAll('.button--prev');
			const flkty = new Flickity(slider, {
				cellSelector: '.recent-work-slider-item',
				prevNextButtons: false,
				wrapAround: true,
				pageDots: false,
				fade: true,
				imagesLoaded: true
			});
			next.forEach(function (button) {
				button.addEventListener('click', function () {
					flkty.next();
				});
			});
			prev.forEach(function (button) {
				button.addEventListener('click', function () {
					flkty.previous();
				});
			});
			luge.emitter.emit('resize');
		}
	});
</script>
